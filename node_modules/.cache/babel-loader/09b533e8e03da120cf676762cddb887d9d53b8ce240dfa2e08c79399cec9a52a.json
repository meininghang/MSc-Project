{"ast":null,"code":"\"use strict\";\n\nrequire(\"core-js/modules/es.typed-array.to-reversed.js\");\nrequire(\"core-js/modules/es.typed-array.to-sorted.js\");\nrequire(\"core-js/modules/es.typed-array.with.js\");\nrequire(\"core-js/modules/es.array.push.js\");\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.Tag = void 0;\nconst ArweaveUtils = require(\"./utils\");\nconst deepHash_1 = require(\"./deepHash\");\nconst merkle_1 = require(\"./merkle\");\nclass BaseObject {\n  get(field, options) {\n    if (!Object.getOwnPropertyNames(this).includes(field)) {\n      throw new Error(`Field \"${field}\" is not a property of the Arweave Transaction class.`);\n    }\n    // Handle fields that are Uint8Arrays.\n    // To maintain compat we encode them to b64url\n    // if decode option is not specificed.\n    if (this[field] instanceof Uint8Array) {\n      if (options && options.decode && options.string) {\n        return ArweaveUtils.bufferToString(this[field]);\n      }\n      if (options && options.decode && !options.string) {\n        return this[field];\n      }\n      return ArweaveUtils.bufferTob64Url(this[field]);\n    }\n    if (options && options.decode == true) {\n      if (options && options.string) {\n        return ArweaveUtils.b64UrlToString(this[field]);\n      }\n      return ArweaveUtils.b64UrlToBuffer(this[field]);\n    }\n    return this[field];\n  }\n}\nclass Tag extends BaseObject {\n  constructor(name, value, decode = false) {\n    super();\n    this.name = name;\n    this.value = value;\n  }\n}\nexports.Tag = Tag;\nclass Transaction extends BaseObject {\n  constructor(attributes = {}) {\n    super();\n    this.format = 2;\n    this.id = \"\";\n    this.last_tx = \"\";\n    this.owner = \"\";\n    this.tags = [];\n    this.target = \"\";\n    this.quantity = \"0\";\n    this.data_size = \"0\";\n    this.data = new Uint8Array();\n    this.data_root = \"\";\n    this.reward = \"0\";\n    this.signature = \"\";\n    Object.assign(this, attributes);\n    // If something passes in a Tx that has been toJSON'ed and back,\n    // or where the data was filled in from /tx/data endpoint.\n    // data will be b64url encoded, so decode it.\n    if (typeof this.data === \"string\") {\n      this.data = ArweaveUtils.b64UrlToBuffer(this.data);\n    }\n    if (attributes.tags) {\n      this.tags = attributes.tags.map(tag => {\n        return new Tag(tag.name, tag.value);\n      });\n    }\n  }\n  addTag(name, value) {\n    this.tags.push(new Tag(ArweaveUtils.stringToB64Url(name), ArweaveUtils.stringToB64Url(value)));\n  }\n  toJSON() {\n    return {\n      format: this.format,\n      id: this.id,\n      last_tx: this.last_tx,\n      owner: this.owner,\n      tags: this.tags,\n      target: this.target,\n      quantity: this.quantity,\n      data: ArweaveUtils.bufferTob64Url(this.data),\n      data_size: this.data_size,\n      data_root: this.data_root,\n      data_tree: this.data_tree,\n      reward: this.reward,\n      signature: this.signature\n    };\n  }\n  setOwner(owner) {\n    this.owner = owner;\n  }\n  setSignature({\n    id,\n    owner,\n    reward,\n    tags,\n    signature\n  }) {\n    this.id = id;\n    this.owner = owner;\n    if (reward) this.reward = reward;\n    if (tags) this.tags = tags;\n    this.signature = signature;\n  }\n  async prepareChunks(data) {\n    // Note: we *do not* use `this.data`, the caller may be\n    // operating on a transaction with an zero length data field.\n    // This function computes the chunks for the data passed in and\n    // assigns the result to this transaction. It should not read the\n    // data *from* this transaction.\n    if (!this.chunks && data.byteLength > 0) {\n      this.chunks = await (0, merkle_1.generateTransactionChunks)(data);\n      this.data_root = ArweaveUtils.bufferTob64Url(this.chunks.data_root);\n    }\n    if (!this.chunks && data.byteLength === 0) {\n      this.chunks = {\n        chunks: [],\n        data_root: new Uint8Array(),\n        proofs: []\n      };\n      this.data_root = \"\";\n    }\n  }\n  // Returns a chunk in a format suitable for posting to /chunk.\n  // Similar to `prepareChunks()` this does not operate `this.data`,\n  // instead using the data passed in.\n  getChunk(idx, data) {\n    if (!this.chunks) {\n      throw new Error(`Chunks have not been prepared`);\n    }\n    const proof = this.chunks.proofs[idx];\n    const chunk = this.chunks.chunks[idx];\n    return {\n      data_root: this.data_root,\n      data_size: this.data_size,\n      data_path: ArweaveUtils.bufferTob64Url(proof.proof),\n      offset: proof.offset.toString(),\n      chunk: ArweaveUtils.bufferTob64Url(data.slice(chunk.minByteRange, chunk.maxByteRange))\n    };\n  }\n  async getSignatureData() {\n    switch (this.format) {\n      case 1:\n        let tags = this.tags.reduce((accumulator, tag) => {\n          return ArweaveUtils.concatBuffers([accumulator, tag.get(\"name\", {\n            decode: true,\n            string: false\n          }), tag.get(\"value\", {\n            decode: true,\n            string: false\n          })]);\n        }, new Uint8Array());\n        return ArweaveUtils.concatBuffers([this.get(\"owner\", {\n          decode: true,\n          string: false\n        }), this.get(\"target\", {\n          decode: true,\n          string: false\n        }), this.get(\"data\", {\n          decode: true,\n          string: false\n        }), ArweaveUtils.stringToBuffer(this.quantity), ArweaveUtils.stringToBuffer(this.reward), this.get(\"last_tx\", {\n          decode: true,\n          string: false\n        }), tags]);\n      case 2:\n        if (!this.data_root) {\n          await this.prepareChunks(this.data);\n        }\n        const tagList = this.tags.map(tag => [tag.get(\"name\", {\n          decode: true,\n          string: false\n        }), tag.get(\"value\", {\n          decode: true,\n          string: false\n        })]);\n        return await (0, deepHash_1.default)([ArweaveUtils.stringToBuffer(this.format.toString()), this.get(\"owner\", {\n          decode: true,\n          string: false\n        }), this.get(\"target\", {\n          decode: true,\n          string: false\n        }), ArweaveUtils.stringToBuffer(this.quantity), ArweaveUtils.stringToBuffer(this.reward), this.get(\"last_tx\", {\n          decode: true,\n          string: false\n        }), tagList, ArweaveUtils.stringToBuffer(this.data_size), this.get(\"data_root\", {\n          decode: true,\n          string: false\n        })]);\n      default:\n        throw new Error(`Unexpected transaction format: ${this.format}`);\n    }\n  }\n}\nexports.default = Transaction;","map":{"version":3,"names":["ArweaveUtils","require","deepHash_1","merkle_1","BaseObject","get","field","options","Object","getOwnPropertyNames","includes","Error","Uint8Array","decode","string","bufferToString","bufferTob64Url","b64UrlToString","b64UrlToBuffer","Tag","constructor","name","value","exports","Transaction","attributes","format","id","last_tx","owner","tags","target","quantity","data_size","data","data_root","reward","signature","assign","map","tag","addTag","push","stringToB64Url","toJSON","data_tree","setOwner","setSignature","prepareChunks","chunks","byteLength","generateTransactionChunks","proofs","getChunk","idx","proof","chunk","data_path","offset","toString","slice","minByteRange","maxByteRange","getSignatureData","reduce","accumulator","concatBuffers","stringToBuffer","tagList","default"],"sources":["../../../../src/common/lib/transaction.ts"],"sourcesContent":[null],"mappings":"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"},"metadata":{},"sourceType":"script","externalDependencies":[]}