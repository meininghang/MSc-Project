{"ast":null,"code":"\"use strict\";\n\nvar __importDefault = this && this.__importDefault || function (mod) {\n  return mod && mod.__esModule ? mod : {\n    \"default\": mod\n  };\n};\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.erc20abi = void 0;\nconst bignumber_js_1 = __importDefault(require(\"bignumber.js\"));\nconst ethers_1 = require(\"ethers\");\nconst currency_1 = require(\"../currency\");\nconst ethereum_1 = __importDefault(require(\"./ethereum\"));\nclass ERC20Config extends ethereum_1.default {\n  constructor(config) {\n    super(config);\n    this.contractAddress = config.contractAddress;\n  }\n  async getContract() {\n    if (!this.contractInstance) {\n      this.contractInstance = new ethers_1.ethers.Contract(this.contractAddress, exports.erc20abi, this.w3signer);\n      this.base = [\"wei\", Math.pow(10, await this.contractInstance.decimals())];\n    }\n    return this.contractInstance;\n  }\n  async getTx(txId) {\n    const response = await this.providerInstance.getTransaction(txId);\n    if (!response) throw new Error(\"Tx doesn't exist\");\n    if (response.data.length !== 138 || response.data.slice(2, 10) !== \"a9059cbb\" // standard ERC20-ABI method ID for transfers\n    ) {\n      throw new Error(\"Tx isn't a ERC20 transfer\");\n    }\n    const to = `0x${response.data.slice(34, 74)}`;\n    const amount = new bignumber_js_1.default(response.data.slice(74), 16);\n    return {\n      from: response.from,\n      to,\n      blockHeight: response.blockNumber ? new bignumber_js_1.default(response.blockNumber) : null,\n      amount,\n      pending: response.blockNumber ? false : true,\n      confirmed: response.confirmations >= this.minConfirm\n    };\n  }\n  /**\n   * Returns the fee in CONTRACT CURRENCY UNITS equivalent to the fee derived via gas currency units, i.e Wei\n   * @param amount\n   * @param to\n   * @returns\n   */\n  async getFee(amount, to) {\n    const _amount = \"0x\" + new bignumber_js_1.default(amount).toString(16);\n    const contract = await this.getContract();\n    const gasPrice = await this.providerInstance.getGasPrice();\n    const gasLimit = await contract.estimateGas.transfer(to, _amount);\n    const units = new bignumber_js_1.default(gasPrice.mul(gasLimit).toString()); // price in WEI\n    const [fiatGasPrice] = await this.getGas(); // get price of gas units\n    const value = fiatGasPrice.multipliedBy(units); // value of the fee\n    // convert value \n    const ctPrice = new bignumber_js_1.default(await this.price()); // price for this currency\n    const ctAmount = new bignumber_js_1.default(value).dividedToIntegerBy(ctPrice);\n    // const b = ctAmount.multipliedBy(ctPrice)\n    // const c = value.dividedBy(this.base[1])\n    // console.log(b);\n    // console.log(c)\n    return ctAmount;\n  }\n  async createTx(amount, to, _fee) {\n    // const provider = await this.getProvider()\n    // const wallet = new Wallet(this.wallet, this.providerInstance);\n    const contract = await this.getContract();\n    const _amount = \"0x\" + new bignumber_js_1.default(amount).toString(16);\n    const tx = await contract.populateTransaction.transfer(to, _amount);\n    // Needed *specifically* for ERC20\n    tx.gasPrice = await this.providerInstance.getGasPrice();\n    tx.gasLimit = await contract.estimateGas.transfer(to, _amount);\n    tx.chainId = (await this.providerInstance.getNetwork()).chainId;\n    tx.nonce = await this.providerInstance.getTransactionCount(this.address);\n    // const txr = this.w3signer.populateTransaction()\n    // const signedTx = await this.wallet.signTransaction(tx);\n    // const txId = \"0x\" + keccak256(Buffer.from(signedTx.slice(2), \"hex\")).toString(\"hex\");\n    return {\n      txId: undefined,\n      tx: tx\n    };\n  }\n  // TODO: create a nicer solution than just overrides (larger issue: some currencies aren't on redstone)\n  async getGas() {\n    return [new bignumber_js_1.default(await (0, currency_1.getRedstonePrice)(\"ETH\")), 1e18];\n  }\n}\nexports.default = ERC20Config;\nexports.erc20abi = [{\n  \"constant\": true,\n  \"inputs\": [],\n  \"name\": \"name\",\n  \"outputs\": [{\n    \"name\": \"\",\n    \"type\": \"string\"\n  }],\n  \"payable\": false,\n  \"stateMutability\": \"view\",\n  \"type\": \"function\"\n}, {\n  \"constant\": false,\n  \"inputs\": [{\n    \"name\": \"_spender\",\n    \"type\": \"address\"\n  }, {\n    \"name\": \"_value\",\n    \"type\": \"uint256\"\n  }],\n  \"name\": \"approve\",\n  \"outputs\": [{\n    \"name\": \"\",\n    \"type\": \"bool\"\n  }],\n  \"payable\": false,\n  \"stateMutability\": \"nonpayable\",\n  \"type\": \"function\"\n}, {\n  \"constant\": true,\n  \"inputs\": [],\n  \"name\": \"totalSupply\",\n  \"outputs\": [{\n    \"name\": \"\",\n    \"type\": \"uint256\"\n  }],\n  \"payable\": false,\n  \"stateMutability\": \"view\",\n  \"type\": \"function\"\n}, {\n  \"constant\": false,\n  \"inputs\": [{\n    \"name\": \"_from\",\n    \"type\": \"address\"\n  }, {\n    \"name\": \"_to\",\n    \"type\": \"address\"\n  }, {\n    \"name\": \"_value\",\n    \"type\": \"uint256\"\n  }],\n  \"name\": \"transferFrom\",\n  \"outputs\": [{\n    \"name\": \"\",\n    \"type\": \"bool\"\n  }],\n  \"payable\": false,\n  \"stateMutability\": \"nonpayable\",\n  \"type\": \"function\"\n}, {\n  \"constant\": true,\n  \"inputs\": [],\n  \"name\": \"decimals\",\n  \"outputs\": [{\n    \"name\": \"\",\n    \"type\": \"uint8\"\n  }],\n  \"payable\": false,\n  \"stateMutability\": \"view\",\n  \"type\": \"function\"\n}, {\n  \"constant\": true,\n  \"inputs\": [{\n    \"name\": \"_owner\",\n    \"type\": \"address\"\n  }],\n  \"name\": \"balanceOf\",\n  \"outputs\": [{\n    \"name\": \"balance\",\n    \"type\": \"uint256\"\n  }],\n  \"payable\": false,\n  \"stateMutability\": \"view\",\n  \"type\": \"function\"\n}, {\n  \"constant\": true,\n  \"inputs\": [],\n  \"name\": \"symbol\",\n  \"outputs\": [{\n    \"name\": \"\",\n    \"type\": \"string\"\n  }],\n  \"payable\": false,\n  \"stateMutability\": \"view\",\n  \"type\": \"function\"\n}, {\n  \"constant\": false,\n  \"inputs\": [{\n    \"name\": \"_to\",\n    \"type\": \"address\"\n  }, {\n    \"name\": \"_value\",\n    \"type\": \"uint256\"\n  }],\n  \"name\": \"transfer\",\n  \"outputs\": [{\n    \"name\": \"\",\n    \"type\": \"bool\"\n  }],\n  \"payable\": false,\n  \"stateMutability\": \"nonpayable\",\n  \"type\": \"function\"\n}, {\n  \"constant\": true,\n  \"inputs\": [{\n    \"name\": \"_owner\",\n    \"type\": \"address\"\n  }, {\n    \"name\": \"_spender\",\n    \"type\": \"address\"\n  }],\n  \"name\": \"allowance\",\n  \"outputs\": [{\n    \"name\": \"\",\n    \"type\": \"uint256\"\n  }],\n  \"payable\": false,\n  \"stateMutability\": \"view\",\n  \"type\": \"function\"\n}, {\n  \"payable\": true,\n  \"stateMutability\": \"payable\",\n  \"type\": \"fallback\"\n}, {\n  \"anonymous\": false,\n  \"inputs\": [{\n    \"indexed\": true,\n    \"name\": \"owner\",\n    \"type\": \"address\"\n  }, {\n    \"indexed\": true,\n    \"name\": \"spender\",\n    \"type\": \"address\"\n  }, {\n    \"indexed\": false,\n    \"name\": \"value\",\n    \"type\": \"uint256\"\n  }],\n  \"name\": \"Approval\",\n  \"type\": \"event\"\n}, {\n  \"anonymous\": false,\n  \"inputs\": [{\n    \"indexed\": true,\n    \"name\": \"from\",\n    \"type\": \"address\"\n  }, {\n    \"indexed\": true,\n    \"name\": \"to\",\n    \"type\": \"address\"\n  }, {\n    \"indexed\": false,\n    \"name\": \"value\",\n    \"type\": \"uint256\"\n  }],\n  \"name\": \"Transfer\",\n  \"type\": \"event\"\n}];","map":{"version":3,"names":["bignumber_js_1","__importDefault","require","ethers_1","currency_1","ethereum_1","ERC20Config","default","constructor","config","contractAddress","getContract","contractInstance","ethers","Contract","exports","erc20abi","w3signer","base","Math","pow","decimals","getTx","txId","response","providerInstance","getTransaction","Error","data","length","slice","to","amount","from","blockHeight","blockNumber","pending","confirmed","confirmations","minConfirm","getFee","_amount","toString","contract","gasPrice","getGasPrice","gasLimit","estimateGas","transfer","units","mul","fiatGasPrice","getGas","value","multipliedBy","ctPrice","price","ctAmount","dividedToIntegerBy","createTx","_fee","tx","populateTransaction","chainId","getNetwork","nonce","getTransactionCount","address","undefined","getRedstonePrice"],"sources":["../../../src/web/currencies/erc20.ts"],"sourcesContent":[null],"mappings":"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"},"metadata":{},"sourceType":"script","externalDependencies":[]}