{"ast":null,"code":"\"use strict\";\n\nrequire(\"core-js/modules/es.array.push.js\");\nvar __importDefault = this && this.__importDefault || function (mod) {\n  return mod && mod.__esModule ? mod : {\n    \"default\": mod\n  };\n};\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nconst base64url_1 = __importDefault(require(\"base64url\"));\nconst utils_1 = require(\"./utils\");\nconst DataItem_1 = __importDefault(require(\"./DataItem\"));\nconst crypto_browserify_1 = require(\"crypto-browserify\");\nconst HEADER_START = 32;\nclass Bundle {\n  constructor(binary) {\n    this.binary = binary;\n    this.length = this.getDataItemCount();\n    this.items = this.getItems();\n  }\n  getRaw() {\n    return this.binary;\n  }\n  /**\n   * Get a DataItem by index (`number`) or by txId (`string`)\n   * @param index\n   */\n  get(index) {\n    if (typeof index === \"number\") {\n      if (index >= this.length) {\n        throw new RangeError(\"Index out of range\");\n      }\n      return this.getByIndex(index);\n    } else {\n      return this.getById(index);\n    }\n  }\n  getSizes() {\n    const ids = [];\n    for (let i = HEADER_START; i < HEADER_START + 64 * this.length; i += 64) {\n      ids.push(utils_1.byteArrayToLong(this.binary.subarray(i, i + 32)));\n    }\n    return ids;\n  }\n  getIds() {\n    const ids = [];\n    for (let i = HEADER_START; i < HEADER_START + 64 * this.length; i += 64) {\n      ids.push(base64url_1.default.encode(this.binary.subarray(i + 32, i + 64)));\n    }\n    return ids;\n  }\n  getIdBy(index) {\n    if (index > this.length - 1) {\n      throw new RangeError(\"Index of bundle out of range\");\n    }\n    const start = 64 + 64 * index;\n    return base64url_1.default.encode(this.binary.subarray(start, start + 32));\n  }\n  async toTransaction(attributes, arweave, jwk) {\n    const tx = await arweave.createTransaction({\n      data: this.binary,\n      ...attributes\n    }, jwk);\n    tx.addTag(\"Bundle-Format\", \"binary\");\n    tx.addTag(\"Bundle-Version\", \"2.0.0\");\n    return tx;\n  }\n  async verify() {\n    for (const item of this.items) {\n      const valid = await item.isValid();\n      const expected = base64url_1.default(crypto_browserify_1.createHash(\"sha256\").update(item.rawSignature).digest());\n      if (!(valid && item.id === expected)) {\n        return false;\n      }\n    }\n    return true;\n  }\n  getOffset(id) {\n    let offset = 0;\n    for (let i = HEADER_START; i < HEADER_START + 64 * this.length; i += 64) {\n      const _offset = utils_1.byteArrayToLong(this.binary.subarray(i, i + 32));\n      offset += _offset;\n      const _id = this.binary.subarray(i + 32, i + 64);\n      if (utils_1.arraybufferEqual(_id, id)) {\n        return {\n          startOffset: offset,\n          size: _offset\n        };\n      }\n    }\n    return {\n      startOffset: -1,\n      size: -1\n    };\n  }\n  // TODO: Test this\n  /**\n   * UNSAFE! Assumes index < length\n   * @param index\n   * @private\n   */\n  getByIndex(index) {\n    let offset = 0;\n    const headerStart = 32 + 64 * index;\n    const dataItemSize = utils_1.byteArrayToLong(this.binary.subarray(headerStart, headerStart + 32));\n    let counter = 0;\n    for (let i = HEADER_START; i < HEADER_START + 64 * this.length; i += 64) {\n      if (counter == index) {\n        break;\n      }\n      const _offset = utils_1.byteArrayToLong(this.binary.subarray(i, i + 32));\n      offset += _offset;\n      counter++;\n    }\n    const bundleStart = this.getBundleStart();\n    const dataItemStart = bundleStart + offset;\n    const slice = this.binary.subarray(dataItemStart, dataItemStart + dataItemSize + 200);\n    const item = new DataItem_1.default(slice);\n    item.rawId = this.binary.slice(32 + 64 * index, 64 + 64 * index);\n    return item;\n  }\n  getById(id) {\n    const _id = base64url_1.default.toBuffer(id);\n    const offset = this.getOffset(_id);\n    if (offset.startOffset === -1) {\n      throw new Error(\"Transaction not found\");\n    }\n    const bundleStart = this.getBundleStart();\n    const dataItemStart = bundleStart + offset.startOffset;\n    return new DataItem_1.default(this.binary.subarray(dataItemStart, dataItemStart + offset.size));\n  }\n  getDataItemCount() {\n    return utils_1.byteArrayToLong(this.binary.subarray(0, 32));\n  }\n  getBundleStart() {\n    return 32 + 64 * this.length;\n  }\n  getItems() {\n    const items = new Array(this.length);\n    let offset = 0;\n    const bundleStart = this.getBundleStart();\n    let counter = 0;\n    for (let i = HEADER_START; i < HEADER_START + 64 * this.length; i += 64) {\n      const _offset = utils_1.byteArrayToLong(this.binary.subarray(i, i + 32));\n      const _id = this.binary.subarray(i + 32, i + 64);\n      const dataItemStart = bundleStart + offset;\n      const bytes = this.binary.subarray(dataItemStart, dataItemStart + _offset);\n      offset += _offset;\n      const item = new DataItem_1.default(bytes);\n      item.rawId = _id;\n      items[counter] = item;\n      counter++;\n    }\n    return items;\n  }\n}\nexports.default = Bundle;","map":{"version":3,"names":["base64url_1","__importDefault","require","utils_1","DataItem_1","crypto_browserify_1","HEADER_START","Bundle","constructor","binary","length","getDataItemCount","items","getItems","getRaw","get","index","RangeError","getByIndex","getById","getSizes","ids","i","push","byteArrayToLong","subarray","getIds","default","encode","getIdBy","start","toTransaction","attributes","arweave","jwk","tx","createTransaction","data","addTag","verify","item","valid","isValid","expected","createHash","update","rawSignature","digest","id","getOffset","offset","_offset","_id","arraybufferEqual","startOffset","size","headerStart","dataItemSize","counter","bundleStart","getBundleStart","dataItemStart","slice","rawId","toBuffer","Error","Array","bytes","exports"],"sources":["Bundle.ts"],"sourcesContent":[null],"mappings":"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"},"metadata":{},"sourceType":"script","externalDependencies":[]}